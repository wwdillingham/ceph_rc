#!/bin/bash
#Wes Dillingham
#wes_dillingham@harvard.edu
#Research Computing - Harvard University 
#All Rights Reserved



###### DO NOT Modify this script outside of the puppet repo, it is a template generated by puppet.
###### Any modifications directly to this file will be overwritten @ the next Puppet Run
#For every Ceph cluster, a group of scripts is to be deployed, including this one, it is dynamically populated by 
#Puppet, as a template, and is specific only to the cluster it is generated for, this is not a general pupose 
#script for use with ANY given ceph cluster, it is only to be used with this cluster: <$CLUSTERNAME>

#Purpose
#This script pulls conf files from all members of the cluster as well as the log file
#That is /etc/ceph.conf of the remote host.
#The script will make a directory in the PWD called ceph.conf_$DATE and will make dubdirectories within called $REMOTE_HOSTNAME
#Inside of which will be the ceph.conf.
#FOR INSTANCE: PWD/ceph.conf_12_24_2015/ceph-osd04/ceph.conf

SCRIPTLOC=`readlink -f $0 | rev | cut -d "/" -f2- | rev`
DATESTRING=`date +%Y"-"%m"-"%d`
ERROR=0

#OSDs
<% for @osd in @osd_hosts -%>
mkdir -p pulled_ceph.conf_$DATESTRING/<%= @osd %>
cd pulled_ceph.conf_$DATESTRING/<%= @osd %>
ceph-deploy --quiet config pull <%= @osd %>
cd $SCRIPTLOC

if [[ -f $SCRIPTLOC/pulled_ceph.conf_$DATESTRING/<%= @osd %>/ceph.conf ]]; then
	echo "Pulled confs for <%= @osd %> and placed them in $SCRIPTLOC/pulled_ceph.conf_$DATESTRING/<%= @osd %>"
else
	echo "There was an error pulling the configuration from <%= @osd %>"
	ERROR=$ERROR+1
fi 
<% end -%>


#MONS
<% for @mon in @mon_hosts -%>
mkdir -p pulled_ceph.conf_$DATESTRING/<%= @mon %>
cd pulled_ceph.conf_$DATESTRING/<%= @mon %>
ceph-deploy --quiet config pull <%= @mon %>
cd $SCRIPTLOC

if [[ -f $SCRIPTLOC/pulled_ceph.conf_$DATESTRING/<%= @mon %>/ceph.conf ]]; then
	echo "Pulled confs for <%= @mon %> and placed them in $SCRIPTLOC/pulled_ceph.conf_$DATESTRING/<%= @mon %>"
else
	echo "There was an error pulling the configuration from <%= @mon %>"
	ERROR=$ERROR+1
fi 
<% end -%>


if [[ $ERROR -gt 0 ]]; then
	echo "WARNING: Not all configuration files were able to be pulled sucesfully"
fi
